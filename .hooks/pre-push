#!/bin/bash

echo "ğŸ” Executando verificaÃ§Ãµes de cÃ³digo em todos os arquivos..."

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# FunÃ§Ã£o para imprimir mensagens coloridas
print_error() { echo -e "${RED}âŒ $1${NC}"; }
print_success() { echo -e "${GREEN}âœ… $1${NC}"; }
print_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
print_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
print_step() { echo -e "${PURPLE}ğŸš€ $1${NC}"; }

# VariÃ¡veis de controle
EXIT_CODE=0
TOTAL_CHECKS=0
PASSED_CHECKS=0

# Verifica dependÃªncias
check_dependencies() {
    print_step "Verificando dependÃªncias..."
    local missing_deps=""

    [ ! -f "vendor/bin/pint" ] && missing_deps="${missing_deps}Laravel Pint\n"
    [ ! -f "vendor/bin/phpstan" ] && missing_deps="${missing_deps}PHPStan/Larastan\n"
    [ ! -f "vendor/bin/pest" ] && missing_deps="${missing_deps}Pest\n"

    if [ -n "$missing_deps" ]; then
        print_error "DependÃªncias nÃ£o encontradas:"
        echo -e "$missing_deps" | while read -r dep; do
            [ -n "$dep" ] && echo "   - $dep"
        done
        echo ""
        print_info "Execute os seguintes comandos:"
        echo "   composer install"
        echo "   composer require --dev larastan/larastan (se ainda nÃ£o instalado)"
        exit 1
    fi

    print_success "Todas as dependÃªncias encontradas!"
    echo ""
}

# ObtÃ©m todos os arquivos PHP do projeto
get_all_php_files() {
    find . -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*" -not -path "./storage/*" -not -path "./bootstrap/cache/*"
}

# Executa Laravel Pint em todos os arquivos
run_pint() {
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    print_step "Executando Laravel Pint (formataÃ§Ã£o de cÃ³digo) em todos os arquivos..."

    if composer test:lint 2>/dev/null; then
        print_success "Laravel Pint: FormataÃ§Ã£o de cÃ³digo aprovada em todos os arquivos!"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    else
        print_error "Laravel Pint: Problemas de formataÃ§Ã£o encontrados."
        echo ""
        print_info "ğŸ’¡ Para corrigir automaticamente:"
        echo "   composer fix"
        echo ""
        return 1
    fi
}

# Executa PHPStan/Larastan em todos os arquivos
run_phpstan() {
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    print_step "Executando PHPStan/Larastan (anÃ¡lise estÃ¡tica) em todos os arquivos..."

    if composer test:types 2>/dev/null; then
        print_success "PHPStan: AnÃ¡lise estÃ¡tica aprovada em todos os arquivos!"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    else
        print_error "PHPStan: Problemas encontrados na anÃ¡lise estÃ¡tica."
        echo ""
        print_info "ğŸ’¡ Para verificar detalhes:"
        echo "   composer test:types"
        echo ""
        return 1
    fi
}

# Executa testes com Pest
run_pest() {
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    print_step "Executando testes com Pest..."

    if composer test:unit 2>/dev/null; then
        print_success "Pest: Todos os testes passaram!"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    else
        print_error "Pest: Alguns testes falharam."
        echo ""
        print_info "ğŸ’¡ Para executar testes individualmente:"
        echo "   composer test:unit"
        echo ""
        return 1
    fi
}

# Mostra estatÃ­sticas finais
show_final_stats() {
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“Š RESUMO DAS VERIFICAÃ‡Ã•ES"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    if [ $EXIT_CODE -eq 0 ]; then
        print_success "ğŸ‰ PUSH APROVADO!"
        print_info "âœ¨ $PASSED_CHECKS/$TOTAL_CHECKS verificaÃ§Ãµes passaram com sucesso!"
    else
        print_error "âŒ PUSH REJEITADO!"
        print_warning "âš ï¸  $PASSED_CHECKS/$TOTAL_CHECKS verificaÃ§Ãµes passaram."
        echo ""
        print_info "ğŸ› ï¸  COMANDOS ÃšTEIS PARA CORREÃ‡ÃƒO:"
        echo ""
        echo "   ğŸ”§ Corrigir automaticamente (formataÃ§Ã£o + refactor):"
        echo "      composer fix"
        echo ""
        echo "   ğŸ” AnÃ¡lise estÃ¡tica:"
        echo "      composer test:types"
        echo ""
        echo "   ğŸ§ª Testes:"
        echo "      composer test:unit"
        echo ""
        echo "   ğŸ“‹ VerificaÃ§Ã£o completa:"
        echo "      composer test"
    fi

    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# FunÃ§Ã£o principal
main() {
    echo ""
    echo "ğŸš€ PRE-PUSH HOOK - VERIFICAÃ‡Ã•ES DE QUALIDADE"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # Verifica dependÃªncias
    check_dependencies

    echo "â„¹ï¸  Verificando todos os arquivos PHP do projeto..."
    echo ""

    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""

    # 1. Executa Laravel Pint
    if ! run_pint; then
        EXIT_CODE=1
    fi
    echo ""

    # 2. Executa PHPStan/Larastan
    if ! run_phpstan; then
        EXIT_CODE=1
    fi
    echo ""

    # 3. Executa Pest (apenas se os passos anteriores passaram)
    if [ $EXIT_CODE -eq 0 ]; then
        if ! run_pest; then
            EXIT_CODE=1
        fi
    else
        print_warning "Pest: Pulando testes devido a problemas anteriores."
        print_info "Corrija os problemas de formataÃ§Ã£o/anÃ¡lise estÃ¡tica primeiro."
        TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    fi

    # Mostra estatÃ­sticas finais
    show_final_stats

    exit $EXIT_CODE
}

# Executa a funÃ§Ã£o principal
main