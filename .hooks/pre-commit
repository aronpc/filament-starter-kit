#!/bin/bash

echo "ğŸ” Executando verificaÃ§Ãµes de cÃ³digo..."

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# FunÃ§Ã£o para imprimir mensagens coloridas
print_error() { echo -e "${RED}âŒ $1${NC}"; }
print_success() { echo -e "${GREEN}âœ… $1${NC}"; }
print_warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
print_info() { echo -e "${BLUE}â„¹ï¸  $1${NC}"; }
print_step() { echo -e "${PURPLE}ğŸš€ $1${NC}"; }

# VariÃ¡veis de controlew
EXIT_CODE=0
TOTAL_CHECKS=0
PASSED_CHECKS=0

# Verifica dependÃªncias
check_dependencies() {
    print_step "Verificando dependÃªncias..."
    local missing_deps=""

    [ ! -f "vendor/bin/pint" ] && missing_deps="${missing_deps}Laravel Pint\n"
    [ ! -f "vendor/bin/phpstan" ] && missing_deps="${missing_deps}PHPStan/Larastan\n"
    [ ! -f "vendor/bin/pest" ] && missing_deps="${missing_deps}Pest\n"

    if [ -n "$missing_deps" ]; then
        print_error "DependÃªncias nÃ£o encontradas:"
        echo -e "$missing_deps" | while read -r dep; do
            [ -n "$dep" ] && echo "   - $dep"
        done
        echo ""
        print_info "Execute os seguintes comandos:"
        echo "   composer install"
        echo "   composer require --dev larastan/larastan (se ainda nÃ£o instalado)"
        exit 1
    fi

    print_success "Todas as dependÃªncias encontradas!"
    echo ""
}

# ObtÃ©m arquivos PHP modificados
get_staged_php_files() {
    git diff --cached --name-only --diff-filter=ACM | grep '\.php$'
}

# ObtÃ©m todos os arquivos modificados
get_all_staged_files() {
    git diff --cached --name-only --diff-filter=ACM
}

# Executa Laravel Pint
run_pint() {
    local staged_files=$1
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))

    if [ -z "$staged_files" ]; then
        print_success "Laravel Pint: Nenhum arquivo PHP para verificar formataÃ§Ã£o."
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    fi

    print_step "Executando Laravel Pint (formataÃ§Ã£o de cÃ³digo)..."

    # Conta arquivos a serem verificados
    local file_count=$(echo "$staged_files" | wc -w)
    print_info "Verificando formataÃ§Ã£o de $file_count arquivo(s)..."

    if composer test:lint 2>/dev/null; then
        print_success "Laravel Pint: FormataÃ§Ã£o de cÃ³digo aprovada!"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    else
        print_error "Laravel Pint: Problemas de formataÃ§Ã£o encontrados."
        echo ""
        print_info "ğŸ’¡ Para corrigir automaticamente:"
        echo "   composer fix"
        echo ""
        print_info "ğŸ“‹ Arquivos com problemas:"
        for file in $staged_files; do
            echo "   - $file"
        done
        return 1
    fi
}

# Executa PHPStan/Larastan
run_phpstan() {
    local staged_files=$1
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))

    if [ -z "$staged_files" ]; then
        print_success "PHPStan: Nenhum arquivo PHP para anÃ¡lise estÃ¡tica."
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    fi

    print_step "Executando PHPStan/Larastan (anÃ¡lise estÃ¡tica)..."

    local file_count=$(echo "$staged_files" | wc -w)
    print_info "Analisando $file_count arquivo(s)..."

    if composer test:types 2>/dev/null; then
        print_success "PHPStan: AnÃ¡lise estÃ¡tica aprovada!"
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    else
        print_error "PHPStan: Problemas encontrados na anÃ¡lise estÃ¡tica."
        echo ""
        print_info "ğŸ’¡ Para verificar detalhes:"
        echo "   composer test:types"
        echo ""
        return 1
    fi
}

# Executa testes com Pest
run_pest() {
    local staged_files=$1
    local all_staged_files=$2
    TOTAL_CHECKS=$((TOTAL_CHECKS + 1))

    print_step "Executando testes com Pest..."

    # Verifica se hÃ¡ arquivos de teste modificados
    local test_files=$(echo "$all_staged_files" | grep "tests/" || echo "")

    if [ -n "$test_files" ]; then
        print_info "Arquivos de teste modificados detectados:"
        for file in $test_files; do
            echo "   - $file"
        done
        print_info "Executando suite completa de testes..."
    elif [ -n "$staged_files" ]; then
        print_info "Executando testes..."
    fi

    if [ -n "$staged_files" ] || [ -n "$test_files" ]; then
        if composer test:unit 2>/dev/null; then
            print_success "Pest: Todos os testes passaram!"
            PASSED_CHECKS=$((PASSED_CHECKS + 1))
            return 0
        else
            print_error "Pest: Alguns testes falharam."
            echo ""
            print_info "ğŸ’¡ Para executar testes individualmente:"
            echo "   composer test:unit"
            echo ""
            return 1
        fi
    else
        print_success "Pest: Nenhum arquivo relevante para testes."
        PASSED_CHECKS=$((PASSED_CHECKS + 1))
        return 0
    fi
}

# Mostra estatÃ­sticas finais
show_final_stats() {
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ“Š RESUMO DAS VERIFICAÃ‡Ã•ES"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    if [ $EXIT_CODE -eq 0 ]; then
        print_success "ğŸ‰ COMMIT APROVADO!"
        print_info "âœ¨ $PASSED_CHECKS/$TOTAL_CHECKS verificaÃ§Ãµes passaram com sucesso!"
    else
        print_error "âŒ COMMIT REJEITADO!"
        print_warning "âš ï¸  $PASSED_CHECKS/$TOTAL_CHECKS verificaÃ§Ãµes passaram."
        echo ""
        print_info "ğŸ› ï¸  COMANDOS ÃšTEIS PARA CORREÃ‡ÃƒO:"
        echo ""
        echo "   ğŸ”§ Corrigir automaticamente (formataÃ§Ã£o + refactor):"
        echo "      composer fix"
        echo ""
        echo "   ğŸ” AnÃ¡lise estÃ¡tica:"
        echo "      composer test:types"
        echo ""
        echo "   ğŸ§ª Testes:"
        echo "      composer test:unit"
        echo ""
        echo "   ğŸ“‹ VerificaÃ§Ã£o completa:"
        echo "      composer test"
    fi

    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
}

# FunÃ§Ã£o principal
main() {
    echo ""
    echo "ğŸš€ PRE-COMMIT HOOK - VERIFICAÃ‡Ã•ES DE QUALIDADE"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    # Verifica dependÃªncias
    check_dependencies

    # ObtÃ©m arquivos modificados
    local staged_php_files=$(get_staged_php_files)
    local all_staged_files=$(get_all_staged_files)

    if [ -z "$staged_php_files" ] && [ -z "$(echo "$all_staged_files" | grep "tests/")" ]; then
        print_success "Nenhum arquivo PHP ou de teste modificado."
        print_info "Commit aprovado sem verificaÃ§Ãµes adicionais."
        exit 0
    fi

    if [ -n "$staged_php_files" ]; then
        print_info "ğŸ“„ Arquivos PHP modificados:"
        for file in $staged_php_files; do
            echo "   â€¢ $file"
        done
        echo ""
    fi

    local test_files=$(echo "$all_staged_files" | grep "tests/" || echo "")
    if [ -n "$test_files" ]; then
        print_info "ğŸ§ª Arquivos de teste modificados:"
        for file in $test_files; do
            echo "   â€¢ $file"
        done
        echo ""
    fi

    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""

    # 1. Executa Laravel Pint
    if ! run_pint "$staged_php_files"; then
        EXIT_CODE=1
    fi
    echo ""

    # 2. Executa PHPStan/Larastan
    if ! run_phpstan "$staged_php_files"; then
        EXIT_CODE=1
    fi
    echo ""

    # 3. Executa Pest (apenas se os passos anteriores passaram ou se forÃ§ado)
    if [ $EXIT_CODE -eq 0 ]; then
        if ! run_pest "$staged_php_files" "$all_staged_files"; then
            EXIT_CODE=1
        fi
    else
        print_warning "Pest: Pulando testes devido a problemas anteriores."
        print_info "Corrija os problemas de formataÃ§Ã£o/anÃ¡lise estÃ¡tica primeiro."
        TOTAL_CHECKS=$((TOTAL_CHECKS + 1))
    fi

    # Mostra estatÃ­sticas finais
    show_final_stats

    exit $EXIT_CODE
}

# Executa a funÃ§Ã£o principal
main
